name: CI/CD Pipeline

on:
  push:
    branches:
      - main
jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
    - name: Verificar código
      uses: actions/checkout@v2

    - name: Fazer login no DockerHub
      run: docker login -u ${{ secrets.DOCKERHUB_USERNAME }} -p ${{ secrets.DOCKERHUB_PASSWORD }}
      
    - name: Build da imagem Docker
      run: docker build -t web-app:latest .
    
    - name: Push da imagem para o DockerHub
      run: docker push web-app:latest

    - name: Limpar credenciais do Docker
      run: docker logout
# jobs:
#   build:
#     runs-on: ubuntu-latest

#     steps:
#     - name: Verificar código-fonte
#       uses: actions/checkout@v4

#     - name: Log in to Docker Hub
#       uses: docker/login-action@f4ef78c080cd8ba55a85445d5b36e214a81df20a
#       with:
#          username: ${{ secrets.DOCKER_USERNAME }}
#          password: ${{ secrets.DOCKER_PASSWORD }}
#          run: |
#           docker build -t web-app:latest .
#           echo $DOCKERHUB_PASSWORD | docker login -u $DOCKERHUB_USERNAME --password-stdin
#           docker tag web-app:latest web-app:1.0
#           docker push web-app:latest
#           docker push web-app:1.0      

  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Código
      uses: actions/checkout@v2

    - name: Configurar AWS CLI
      run: aws configure set aws_access_key_id ${{ secrets.AWS_ACCESS_KEY_ID }} && aws configure set aws_secret_access_key ${{ secrets.AWS_SECRET_ACCESS_KEY }} && aws configure set default.region ${{ secrets.AWS_REGION }}

    - name: Configurar Kubeconfig
      run: aws eks --region us-east-1 update-kubeconfig --name imersao-eks

    - name: Aplicar Configurações do Kubernetes
      run: kubectl apply -f k8s/deployment.yaml

    # - name: Atualizar Imagem do Contêiner (se necessário)
    #   run: |
    #     kubectl set image deployment/seu-deployment seu-container=seu-repo-docker:latest